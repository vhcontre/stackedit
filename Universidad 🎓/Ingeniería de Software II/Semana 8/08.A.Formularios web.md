## üìÖ **Semana 8 ‚Äì Planificaci√≥n t√©cnica**

| Objetivo                               | Implementaci√≥n paso a paso                                                    |
| -------------------------------------- | ----------------------------------------------------------------------------- |
| üíæ **Formulario web para movimientos** | Crear una vista para cargar un nuevo movimiento (alta de stock, retiro, etc.) |
| üß™ **Validaci√≥n con FastAPI + Jinja2** | Validar campos en el backend, mostrar errores si existen                      |

---

### ‚úÖ Paso 1 ‚Äì Crear la ruta y vista del formulario

Vamos a empezar por mostrar un formulario HTML para cargar movimientos.

#### üìÅ `app/templates/movimiento_form.html`

```html
{% extends "base.html" %}
{% block content %}
<h2>üì¶ Registrar Movimiento</h2>

<form action="/web/movimientos" method="post">
    <label for="producto_id">Producto ID:</label>
    <input type="number" name="producto_id" required><br>

    <label for="usuario_id">Usuario ID:</label>
    <input type="number" name="usuario_id" required><br>

    <label for="tipo">Tipo de movimiento:</label>
    <select name="tipo" required>
        <option value="ingreso">Ingreso</option>
        <option value="egreso">Egreso</option>
    </select><br>

    <label for="cantidad">Cantidad:</label>
    <input type="number" name="cantidad" required><br>

    <label for="deposito_origen_id">Dep√≥sito origen (opcional):</label>
    <input type="number" name="deposito_origen_id"><br>

    <label for="deposito_destino_id">Dep√≥sito destino (opcional):</label>
    <input type="number" name="deposito_destino_id"><br>

    <button type="submit">Registrar</button>
</form>

{% if error %}
<p style="color: red;">{{ error }}</p>
{% endif %}
{% endblock %}
```

---

### ‚úÖ Paso 2 ‚Äì Ruta GET y POST para mostrar y procesar el formulario

#### üìÅ `app/routers/web_interface.py` (agreg√° al final)

```python
from fastapi import Form
from fastapi.responses import RedirectResponse
from app.repositories.movimiento_repository import MovimientoRepository
from app.db.session import get_db
from datetime import datetime
from app.repositories.movimiento_repository import MovimientoRepository
from datetime import datetime
from app.domain.models.movimiento import Movimiento, TipoMovimiento as DomainTipoMovimiento
@router.get("/web/movimientos")
def mostrar_formulario_movimiento(request: Request):
    return templates.TemplateResponse("movimiento_form.html", {"request": request})

@router.post("/web/movimientos")
def procesar_formulario_movimiento(
    request: Request,
    producto_id: int = Form(...),
    usuario_id: int = Form(...),
    tipo: str = Form(...),
    cantidad: int = Form(...),
    deposito_origen_id: int = Form(None),
    deposito_destino_id: int = Form(None),
    db: Session = Depends(get_db)
):
    try:
        repo = MovimientoRepository(db)

        movimiento = Movimiento(
            id=None,
            producto_id=producto_id,
            usuario_id=usuario_id,
            cantidad=cantidad,
            tipo=DomainTipoMovimiento(tipo),  # convierte el string a enum
            deposito_origen_id=deposito_origen_id,
            deposito_destino_id=deposito_destino_id,
            fecha=datetime.now().date(),
            timestamp=datetime.now()
        )

        repo.create_movimiento(movimiento)
        return RedirectResponse("/web/productos", status_code=303)

    except Exception as e:
        return templates.TemplateResponse(
            "movimiento_form.html",
            {"request": request, "error": str(e)}
        )

```

---

### ‚úÖ Paso 3 ‚Äì Verificar dependencias

Tu `requirements.txt` debe incluir:

```
python-multipart
```

Ya lo resolviste en la semana pasada. üòâ

---

### ‚úÖ Paso 4 ‚Äì Probar en el navegador

1. Levant√° FastAPI como siempre:

   ```bash
   uvicorn app.main:app
   ```

2. Acced√© a `http://localhost:8000/web/movimientos`

3. Complet√° el formulario y verific√° si se guarda correctamente.

<!--stackedit_data:
eyJoaXN0b3J5IjpbLTU0ODcxNzcxNiwtMzE3OTMxNjczXX0=
-->