## ğŸ“… MÃ³dulo de alertas/reportes

| Semana | Objetivos principales                                             |
| ------ | ----------------------------------------------------------------- |
| 9      | ğŸ“Š MÃ³dulo de alertas/reportes (HTML o CSV)                     |
|        | âœ… NavegaciÃ³n entre vistas (productos / movimientos / reportes) |
|        | ğŸ§ª Pruebas backend y formularios web                           |
|        | ğŸŒ¿ Flujo Git: crear rama + PR para integrar mÃ³dulo             |

### ğŸ§© **Issue #1: Crear reporte de productos con stock bajo**

#### ğŸ“Œ Objetivo:

Mostrar una **tabla web** con los productos cuyo `stock < stock_mÃ­nimo`.

#### âœ… ImplementaciÃ³n paso a paso:

1. **Ruta nueva en `web_interface.py`:**

```python
@router.get("/web/alerta_stock", response_class=HTMLResponse)
def low_stock_report(request: Request, db: Session = Depends(get_db)):
    repo = ProductoRepository(db)
    low_stock_products = repo.get_low_stock_products()
    return templates.TemplateResponse("alerta_stock.html", {
        "request": request,
        "productos": low_stock_products
    })
```

2. **MÃ©todo en `ProductoRepository`:**

```python
def get_low_stock_products(self) -> list[Producto]:
    productos = self.db.query(ProductoORM).filter(ProductoORM.stock < ProductoORM.stock_minimo).all()
    return [producto_orm_to_domain(p) for p in productos]
```

3. **Template `alerta_stock.html`:**

```html
{% extends "base.html" %}
{% block content %}
<h2>ğŸš¨ Productos con stock bajo</h2>
<table>
  <tr><th>ID</th><th>Nombre</th><th>Stock</th><th>MÃ­nimo</th></tr>
  {% for p in productos %}
    <tr>
      <td>{{ p.id }}</td>
      <td>{{ p.nombre }}</td>
      <td>{{ p.stock }}</td>
      <td>{{ p.stock_minimo }}</td>
    </tr>
  {% endfor %}
</table>
{% endblock %}
```

---

### ğŸ§© **Issue #2: Crear vista de movimientos recientes**

#### ğŸ“Œ Objetivo:

Mostrar los Ãºltimos **10 movimientos**, ordenados por fecha.

#### âœ… ImplementaciÃ³n paso a paso:

1. **Nueva ruta:**

```python
@router.get("/web/movimientos_recientes", response_class=HTMLResponse)
def recent_movements_view(request: Request, db: Session = Depends(get_db)):
    repo = MovimientoRepository(db)
    recent = repo.get_recent_movements(limit=10)
    return templates.TemplateResponse("movimientos_recientes.html", {
        "request": request,
        "movimientos": recent
    })
```

2. **MÃ©todo en `MovimientoRepository`:**

```python
def get_recent_movements(self, limit: int = 10) -> list[Movimiento]:
    movimientos = self.db.query(MovimientoORM).order_by(MovimientoORM.timestamp.desc()).limit(limit).all()
    return [movimiento_orm_to_domain(m) for m in movimientos]
```

3. **Template `movimientos_recientes.html`:**

```html
{% extends "base.html" %}
{% block content %}
<h2>ğŸ“„ Movimientos recientes</h2>
<table>
  <tr><th>ID</th><th>Producto</th><th>Tipo</th><th>Cantidad</th><th>Fecha</th></tr>
  {% for m in movimientos %}
    <tr>
      <td>{{ m.id }}</td>
      <td>{{ m.producto_id }}</td>
      <td>{{ m.tipo }}</td>
      <td>{{ m.cantidad }}</td>
      <td>{{ m.fecha }}</td>
    </tr>
  {% endfor %}
</table>
{% endblock %}
```

---

### ğŸ§© **Issue #3: Exportar movimientos a CSV**

#### ğŸ“Œ Objetivo:

Permitir que se descargue un archivo `.csv` con los movimientos.

#### âœ… ImplementaciÃ³n:

1. **Nueva ruta en `web_interface.py`:**

```python
@router.get("/web/exportar_movimientos_csv")
def export_csv(db: Session = Depends(get_db)):
    repo = MovimientoRepository(db)
    movimientos = repo.get_all_movements()

    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(["ID", "Producto", "Tipo", "Cantidad", "Fecha"])
    for m in movimientos:
        writer.writerow([m.id, m.producto_id, m.tipo, m.cantidad, m.fecha])

    response = StreamingResponse(iter([output.getvalue()]),
                                 media_type="text/csv")
    response.headers["Content-Disposition"] = "attachment; filename=movimientos.csv"
    return response
```

2. **Agregar mÃ©todo si no existe aÃºn en el repositorio:**

```python
def get_all_movements(self) -> list[Movimiento]:
    movimientos = self.db.query(MovimientoORM).order_by(MovimientoORM.fecha.desc()).all()
    return [movimiento_orm_to_domain(m) for m in movimientos]
```

---

### ğŸ§© **Issue #4: NavegaciÃ³n entre vistas**

#### ğŸ“Œ Objetivo:

Mejorar la usabilidad con enlaces entre secciones.

#### âœ… ImplementaciÃ³n:

1. **Editar `base.html` para tener navegaciÃ³n:**

```html
<nav>
  <a href="/web/productos">ğŸ“¦ Productos</a> |
  <a href="/web/movimientos">â• Registrar Movimiento</a> |
  <a href="/web/alerta_stock">ğŸš¨ Stock Bajo</a> |
  <a href="/web/movimientos_recientes">ğŸ“„ Movimientos Recientes</a> |
  <a href="/web/exportar_movimientos_csv">â¬‡ï¸ Exportar CSV</a>
</nav>
<hr>
```

---

<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE1ODM4OTcwMDAsLTE2NDA5OTkwNF19
-->