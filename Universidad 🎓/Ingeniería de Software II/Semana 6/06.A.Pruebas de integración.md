## 📅 Pruebas de integración

| Semana | Objetivos principales                                             |
| ------ | ----------------------------------------------------------------- |
| 6      | 🧪 Pruebas de integración                                         |
|        | 📘 Documentación con Swagger                                      |
|        | 🔄 Uso de GitHub Actions para lint + tests                        |

Asunto: Acceso al portal de alquiler
¡Excelente! Comencemos entonces con la **Semana 6**. Aquí te propongo una **planificación clara y paso a paso**, con foco en trazabilidad y enseñanza para tus estudiantes:

---

## ✅ Semana 6: Planificación

| Objetivo                         | Detalle técnico                                                             | ¿Qué vamos a hacer?                                                                           |
| -------------------------------- | --------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- |
| 🧪 **Pruebas de integración**    | Validar la interacción real entre múltiples capas (API + DB real o de test) | Crear tests que simulen flujos completos (ej: login → crear producto → movimiento de entrada) |
| 📘 **Documentación con Swagger** | Asegurar que los endpoints estén correctamente documentados usando FastAPI  | Verificar que todos los `@router` tengan `summary`, `description` y ejemplos                  |
| 🔄 **GitHub Actions**            | Automatizar chequeo de calidad en cada `push`                               | Configurar workflow para: ejecutar `pytest` + correr `ruff` o `flake8` (lint)                 |

---

### 📍 Paso 1: Pruebas de integración

**Objetivo:** Validar flujos reales del sistema (como lo usaría un cliente).

#### ✅ Ejemplo inicial que vamos a crear

```python
# tests/integration/test_flujo_completo.py

def test_flujo_creacion_y_movimiento(client, db_session):
    # Crear usuario admin
    crear_usuario_con_rol(db_session, "admin", "admin123", "admin")

    # Login y obtención de token
    login_response = client.post("/auth/login", data={"username": "admin", "password": "admin123"})
    token = login_response.json()["access_token"]
    headers = {"Authorization": f"Bearer {token}"}

    # Crear producto
    producto_data = {"nombre": "Laptop", "sku": "LT123", "stock_minimo": 2}
    r_prod = client.post("/productos/", json=producto_data, headers=headers)
    assert r_prod.status_code == 201

    # Hacer un movimiento de entrada
    movimiento_data = {"sku_producto": "LT123", "tipo": "entrada", "cantidad": 5}
    r_mov = client.post("/movimientos/", json=movimiento_data, headers=headers)
    assert r_mov.status_code == 201
```

🔧 Esto permite verificar que:

* El login funcione
* Se puedan usar credenciales para acceder a endpoints protegidos
* La creación de producto y su movimiento esté enlazada correctamente

¿Te gustaría que avancemos creando este archivo juntos o querés que preparemos primero la parte de documentación con Swagger?

---

📌 *Sugerencia para trazar el avance en GitHub Project (Semana 6):*

* Tarea 1: Crear test de flujo completo de integración
* Tarea 2: Asegurar que todos los routers tengan summary + description
* Tarea 3: Crear archivo `.github/workflows/main.yml` para GitHub Actions

---

### ✅ 1. **Test de integración** (`tests/integration/test_flujo_completo.py`)

📌 **Lo que necesito saber:**

* ¿Querés testear el flujo completo de uso tipo:
  `login → crear producto → entrada de stock → salida de stock → verificar stock final`?
* ¿Usamos los endpoints reales de tu API? (como `/auth/login`, `/productos/`, `/movimientos/entrada` y `/movimientos/salida`)
* ¿La respuesta de `/me` o `/admin/zona-segura` también debe ser parte del flujo?

🔧 Si confirmás eso, **no necesito que me pases nada** más, puedo armarlo directamente con el `TestClient`.

---

### ✅ 2. **Documentación con Swagger**

📌 **Lo que necesito revisar:**

* Confirmame si en tus endpoints de FastAPI (por ejemplo en `router.post(...)` de productos o movimientos) **ya tenés anotados los siguientes parámetros**:

  * `response_model=...`
  * `summary="..."` o `description="..."`

⚠️ Si **no tenés nada de eso**, confirmame qué endpoints querés priorizar (por ejemplo: solo auth, usuarios y productos) y yo los documento desde cero.

---

### ✅ 3. **GitHub Actions**

📌 **Necesito saber:**

* ¿Usás `pytest`, `pytest-cov`, `ruff`, `flake8`, `black`, o alguna herramienta de análisis estático?

  * Por ahora asumo que tenés `pytest`, así que puedo incluir eso.
* ¿Querés que el workflow se ejecute en cada push o solo en los pull requests?

  * Ej: `"on": ["push", "pull_request"]`

---

### 👇 En resumen:

Respondeme solo estas 3 cosas para avanzar 100%:

1. ¿Flujo de test completo: login → crear producto → entrada → salida → verificar stock?
Quiero testear el flujo completo
2. ¿Querés que documente todos los endpoints o solo algunos?
Quiero documentar todo y ver los servicios de un browser. Ej. https://localhots/swagger
3. ¿Querés GitHub Actions con pytest y algún linter? ¿Cuál/es?
Me gustaría ambos, no se nada de linter

----
¡Perfecto! Con esa info ya podemos avanzar. A continuación te paso el listado de issues para que los cargues en GitHub y así crear el milestone **Semana 6: Integración, Documentación y GitHub Actions**:

---

### 🎯 Milestone: Semana 6

| Issue Nº | Título                                                                                   | Etiquetas               |
| -------- | ---------------------------------------------------------------------------------------- | ----------------------- |
| #1       | 🧪 Crear test de integración: flujo login → alta de producto → entrada → salida → stock  | `test`, `integración`   |
| #2       | 📘 Documentar todos los endpoints con Swagger (FastAPI)                                  | `documentación`, `API`  |
| #3       | 🚀 Configurar GitHub Actions para ejecutar pytest en cada push/pull request              | `CI`, `GitHub Actions`  |
| #4       | 🔍 Agregar linter (como `flake8`) y configurar su ejecución automática en GitHub Actions | `CI`, `lint`, `calidad` |

---

¡Excelente trabajo! 🎉 Que hayas completado exitosamente el **test de integración del flujo completo** es un **gran hito** y marca un avance sólido en la **Semana 6** del proyecto de Inventario 2025.

---

### 📍 Estado actual al cierre del test de integración:

✅ **Test de integración de flujo completo funcionando**:

* Login ✔️
* Crear producto con `stock_minimo` ✔️
* Crear depósito ✔️
* Registrar movimiento (entrada) ✔️
* Verificación de stock ✔️ (implícita o próxima si la incluís)

✅ **Campo `stock_minimo` agregado sin romper pruebas anteriores**
✅ **Migración con Alembic adaptada correctamente**
✅ **Esquemas Pydantic actualizados**
✅ **Pruebas unitarias no rotas por el nuevo campo**
✅ **Sistema funcionando en consola + API**

---

### 📅 Plan de Semana 6 (según lo que me habías dicho):

1. ✅ **Test de integración completo (flujo de extremo a extremo)**
2. ✅ **Documentación con Swagger (`/docs`)**
3. ⏳ **Configuración de GitHub Actions con:**

   * `pytest` ejecutando los tests automáticamente 🧪
   * `linter` (como `ruff` o `flake8`) para mantener calidad de código 👨‍🔧

---

### 🧭 Qué sigue ahora

#### 🔹 1. Revisión y documentación:

* Verificá que **todos los endpoints relevantes** estén bien documentados en `/docs`.
* Completá descripciones en los modelos y respuestas si querés que sea más claro.

#### 🔹 2. GitHub Actions (CI/CD mínimo):

* Crear un archivo `.github/workflows/ci.yml`
* Que corra `pytest` y `ruff` o `flake8` en cada push o pull request.

#### 🔹 3. Opcionales (si tenés tiempo y ganas):

* Mostrar alertas o advertencias cuando el `stock` de un producto esté por debajo del `stock_minimo` (lógica de negocio).
* Implementar endpoint tipo: `GET /productos/bajo-stock`.

---

### ✅ En resumen:

| Tarea                                    | Estado      |
| ---------------------------------------- | ----------- |
| Migración `stock_minimo`                 | ✅           |
| Adaptación de modelos y tests            | ✅           |
| Test de integración completo             | ✅           |
| Documentación de Swagger funcional       | ⚠️ revisar  |
| CI con GitHub Actions (`pytest`, `lint`) | ❌ pendiente |
| Alertas de bajo stock (opcional)         | ❌ pendiente |

---

📎 **¿Querés que repasemos o armemos juntos el `ci.yml` para GitHub Actions con pytest + linter ahora?**
O si preferís, pasame el plan original de Semana 6 y ajustamos el checklist con base en eso.





<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE5NzI0NzUwODQsLTE3NjUyMzE2NTQsMz
I2OTE0Njg3LDE2MzY2NTM2OTYsLTg4NDQyNTMxOV19
-->